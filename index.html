<script>
  // ===== Helper: Smooth scroll =====
  function scrollToSection(id){
    const el = document.getElementById(id);
    if(el) el.scrollIntoView({behavior:'smooth', block:'start'});
  }

  // ===== Modal handler =====
  function openModal(which){
    const content = {
      privacy: '<h3>Privacy Policy</h3><p class="small">Replace with your real policy.</p>',
      terms: '<h3>Terms</h3><p class="small">Replace with your real TOS.</p>',
      contact: '<h3>Contact</h3><p class="small">Email: <a href="mailto:admin@mastercars.example">admin@mastercars.example</a></p>'
    };
    const modal = document.getElementById('modal');
    document.getElementById('modal-content').innerHTML = content[which] || '';
    modal.style.display = 'flex';
  }
  function closeModal(){ document.getElementById('modal').style.display='none'; }

  // ===== JSONP fetch =====
  function jsonpCarQuery(url){
    return new Promise((resolve,reject)=>{
      const cbName = 'cqcb_'+Math.random().toString(36).substr(2,8);
      const script = document.createElement('script');
      script.src = url + '&callback=' + cbName;
      script.onerror = ()=>{ reject('JSONP failed'); };
      window[cbName] = function(data){
        resolve(data);
        delete window[cbName];
        if(script.parentNode) script.parentNode.removeChild(script);
      };
      document.body.appendChild(script);
    });
  }

  // ===== Fetch car info =====
  async function fetchCarInfo(){
    const make=document.getElementById('ci-make').value.trim();
    const model=document.getElementById('ci-model').value.trim();
    const out=document.getElementById('car-info-result');
    out.style.display='block';
    if(!make||!model){ out.innerHTML='<span style="color:#b91c1c">Enter both make and model.</span>'; return;}
    out.innerHTML='<em>Loading car data…</em>';

    try{
      const data = await jsonpCarQuery(`https://www.carqueryapi.com/api/0.3/?cmd=getTrims&make=${encodeURIComponent(make)}&model=${encodeURIComponent(model)}`);
      if(!data?.Trims?.length){ out.innerHTML='<span class="small">No data found.</span>'; return;}
      const t = data.Trims.sort((a,b)=>(b.model_year||0)-(a.model_year||0))[0];
      const specs={
        'Make': t.make_display||make,
        'Model': t.model_name||model,
        'Year': t.model_year||'—',
        'Body': t.model_body||'—',
        'Engine Type': t.model_engine_type||'—',
        'Cylinders': t.model_engine_cyl||'—',
        'Displacement (cc)': t.model_engine_cc||'—',
        'Power (hp)': t.model_engine_power_ps||'—',
        'Torque (Nm)': t.model_engine_torque_nm||'—',
        'Transmission': t.model_transmission_type||'—',
        'Fuel Type': t.model_engine_fuel||'—',
        'Doors': t.model_doors||'—',
        'Seats': t.model_seats||'—'
      };
      let html=`<strong>${specs.Make} ${specs.Model} — ${specs.Year}</strong><table style="margin-top:8px">`;
      for(const k in specs) html+=`<tr><th style="width:40%">${k}</th><td>${specs[k]}</td></tr>`;
      html+='</table><div class="small" style="margin-top:8px">Source: CarQuery API</div>';
      out.innerHTML=html;
    } catch(err){ console.error(err); out.innerHTML='<span style="color:#b91c1c">Error fetching data.</span>'; }
  }

  function clearCarInfo(){ ['ci-make','ci-model'].forEach(id=>document.getElementById(id).value=''); const out=document.getElementById('car-info-result'); out.style.display='none'; out.innerHTML=''; }

  // ===== Compare cars =====
  async function compareCars(){
    const make1=document.getElementById('cmp-make1').value.trim();
    const model1=document.getElementById('cmp-model1').value.trim();
    const make2=document.getElementById('cmp-make2').value.trim();
    const model2=document.getElementById('cmp-model2').value.trim();
    const out=document.getElementById('compare-result');
    out.style.display='block';
    if(!make1||!model1||!make2||!model2){ out.innerHTML='<span style="color:#b91c1c">Fill all fields.</span>'; return;}
    out.innerHTML='<em>Loading comparison…</em>';

    try{
      const [d1,d2] = await Promise.all([
        jsonpCarQuery(`https://www.carqueryapi.com/api/0.3/?cmd=getTrims&make=${encodeURIComponent(make1)}&model=${encodeURIComponent(model1)}`),
        jsonpCarQuery(`https://www.carqueryapi.com/api/0.3/?cmd=getTrims&make=${encodeURIComponent(make2)}&model=${encodeURIComponent(model2)}`)
      ]);
      if(!d1?.Trims?.length || !d2?.Trims?.length){ out.innerHTML='<span class="small">Models not found.</span>'; return;}
      const t1=d1.Trims.sort((a,b)=>(b.model_year||0)-(a.model_year||0))[0];
      const t2=d2.Trims.sort((a,b)=>(b.model_year||0)-(a.model_year||0))[0];
      const fields=[
        ['Make',t1.make_display||'—',t2.make_display||'—'],
        ['Model',t1.model_name||'—',t2.model_name||'—'],
        ['Year',t1.model_year||'—',t2.model_year||'—'],
        ['Body',t1.model_body||'—',t2.model_body||'—'],
        ['Engine (cc)',t1.model_engine_cc||'—',t2.model_engine_cc||'—'],
        ['Power (hp)',t1.model_engine_power_ps||'—',t2.model_engine_power_ps||'—'],
        ['Torque (Nm)',t1.model_engine_torque_nm||'—',t2.model_engine_torque_nm||'—'],
        ['Fuel',t1.model_engine_fuel||'—',t2.model_engine_fuel||'—'],
        ['Transmission',t1.model_transmission_type||'—',t2.model_transmission_type||'—'],
        ['Doors',t1.model_doors||'—',t2.model_doors||'—'],
        ['Seats',t1.model_seats||'—',t2.model_seats||'—']
      ];
      let html=`<table class="compareTable"><thead><tr><th></th><th>${t1.make_display||make1} ${t1.model_name||model1}</th><th>${t2.make_display||make2} ${t2.model_name||model2}</th></tr></thead><tbody>`;
      fields.forEach(([label,v1,v2])=>html+=`<tr><th>${label}</th><td>${v1}</td><td>${v2}</td></tr>`);
      html+='</tbody></table><div class="small" style="margin-top:8px">Source: CarQuery API</div>';
      out.innerHTML=html;
    }catch(err){ console.error(err); out.innerHTML='<span style="color:#b91c1c">Error fetching comparison.</span>'; }
  }

  function clearCompare(){ ['cmp-make1','cmp-model1','cmp-make2','cmp-model2'].forEach(id=>document.getElementById(id).value=''); const out=document.getElementById('compare-result'); out.style.display='none'; out.innerHTML=''; }

  // ===== Fuel calculator =====
  function calcFuel(){
    const d=parseFloat(document.getElementById('fc-distance').value);
    const eff=parseFloat(document.getElementById('fc-efficiency').value);
    const price=parseFloat(document.getElementById('fc-price').value);
    const mult=parseFloat(document.getElementById('fc-mult').value)||1;
    const out=document.getElementById('fuel-result');
    out.style.display='block';
    if(!d||!eff||!price){ out.innerHTML='<span style="color:#b91c1c">Fill all fields.</span>'; return;}
    const litres=d/eff;
    const cost=litres*price*mult;
    out.innerHTML=`<div><strong>Fuel needed:</strong> ${litres.toFixed(2)} L</div>
                   <div style="margin-top:6px"><strong>Total cost:</strong> ${cost.toFixed(2)}</div>
                   <div class="small" style="margin-top:6px">Approximation only.</div>`;
  }

  function clearFuel(){ ['fc-distance','fc-efficiency','fc-price'].forEach(id=>document.getElementById(id).value=''); document.getElementById('fc-mult').value='1'; const out=document.getElementById('fuel-result'); out.style.display='none'; out.innerHTML=''; }
</script>
