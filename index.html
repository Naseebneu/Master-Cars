<script>
  // ========= Helper: Smooth scroll =========
  function scrollToSection(id) {
    const el = document.getElementById(id);
    if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }

  // ========= Modal handler =========
  function openModal(which) {
    const content = {
      privacy: '<h3>Privacy Policy (sample)</h3><p class="small">Master Cars respects privacy. Replace with your real policy before applying to AdSense.</p>',
      terms: '<h3>Terms of Service (sample)</h3><p class="small">Use at your own risk. Data from CarQuery may vary.</p>',
      contact: '<h3>Contact</h3><p class="small">Email: <a href="mailto:admin@mastercars.example">admin@mastercars.example</a></p>'
    };
    document.getElementById('modal-content').innerHTML = content[which] || '';
    document.getElementById('modal').style.display = 'flex';
  }
  function closeModal() {
    document.getElementById('modal').style.display = 'none';
  }

  // ========= JSONP fetch (for CarQuery API) =========
  function jsonpCarQuery(url) {
    return new Promise((resolve, reject) => {
      const cbName = 'cqcb_' + Math.random().toString(36).substr(2, 8);
      window[cbName] = function (data) {
        resolve(data);
        delete window[cbName];
        document.body.removeChild(script);
      };
      const script = document.createElement('script');
      script.src = `${url}&callback=${cbName}`;
      script.onerror = reject;
      document.body.appendChild(script);
    });
  }

  // ========= Fetch Car Info =========
  async function fetchCarInfo() {
    const make = document.getElementById('ci-make').value.trim();
    const model = document.getElementById('ci-model').value.trim();
    const out = document.getElementById('car-info-result');
    out.style.display = 'block';

    if (!make || !model) {
      out.innerHTML = '<span style="color:#b91c1c">Please enter both make and model.</span>';
      return;
    }

    out.innerHTML = '<em>Loading car data…</em>';

    try {
      const endpoint = `https://www.carqueryapi.com/api/0.3/?cmd=getTrims&make=${encodeURIComponent(make)}&model=${encodeURIComponent(model)}`;
      const data = await jsonpCarQuery(endpoint);

      if (!data || !data.Trims || data.Trims.length === 0) {
        out.innerHTML = '<span class="small">No data found. Try common names like "Toyota" and "Corolla".</span>';
        return;
      }

      const trim = data.Trims.sort((a, b) => (b.model_year || 0) - (a.model_year || 0))[0];
      const specs = {
        'Make': trim.make_display || make,
        'Model': trim.model_name || model,
        'Year': trim.model_year || '—',
        'Body': trim.model_body || '—',
        'Engine Type': trim.model_engine_type || '—',
        'Cylinders': trim.model_engine_cyl || '—',
        'Displacement (cc)': trim.model_engine_cc || '—',
        'Power (hp)': trim.model_engine_power_ps || '—',
        'Torque (Nm)': trim.model_engine_torque_nm || '—',
        'Transmission': trim.model_transmission_type || '—',
        'Fuel Type': trim.model_engine_fuel || '—',
        'Doors': trim.model_doors || '—',
        'Seats': trim.model_seats || '—'
      };

      let html = `<strong>${specs.Make} ${specs.Model} — ${specs.Year}</strong><table style="margin-top:8px">`;
      for (const k in specs) html += `<tr><th style="width:40%">${k}</th><td>${specs[k]}</td></tr>`;
      html += '</table><div class="small" style="margin-top:8px">Source: CarQuery API</div>';

      out.innerHTML = html;
    } catch (err) {
      console.error(err);
      out.innerHTML = '<span style="color:#b91c1c">Error fetching car data. Please try again later.</span>';
    }
  }

  function clearCarInfo() {
    document.getElementById('ci-make').value = '';
    document.getElementById('ci-model').value = '';
    const out = document.getElementById('car-info-result');
    out.style.display = 'none';
    out.innerHTML = '';
  }

  // ========= Compare Cars (same JSONP logic) =========
  async function compareCars() {
    const make1 = document.getElementById('cmp-make1').value.trim();
    const model1 = document.getElementById('cmp-model1').value.trim();
    const make2 = document.getElementById('cmp-make2').value.trim();
    const model2 = document.getElementById('cmp-model2').value.trim();
    const out = document.getElementById('compare-result');
    out.style.display = 'block';

    if (!make1 || !model1 || !make2 || !model2) {
      out.innerHTML = '<span style="color:#b91c1c">Please fill all fields.</span>';
      return;
    }

    out.innerHTML = '<em>Loading comparison…</em>';

    try {
      const [d1, d2] = await Promise.all([
        jsonpCarQuery(`https://www.carqueryapi.com/api/0.3/?cmd=getTrims&make=${encodeURIComponent(make1)}&model=${encodeURIComponent(model1)}`),
        jsonpCarQuery(`https://www.carqueryapi.com/api/0.3/?cmd=getTrims&make=${encodeURIComponent(make2)}&model=${encodeURIComponent(model2)}`)
      ]);

      if (!d1?.Trims?.length || !d2?.Trims?.length) {
        out.innerHTML = '<span class="small">One or both models not found.</span>';
        return;
      }

      const t1 = d1.Trims.sort((a, b) => (b.model_year || 0) - (a.model_year || 0))[0];
      const t2 = d2.Trims.sort((a, b) => (b.model_year || 0) - (a.model_year || 0))[0];

      const fields = [
        ['Make', t1.make_display, t2.make_display],
        ['Model', t1.model_name, t2.model_name],
        ['Year', t1.model_year, t2.model_year],
        ['Body', t1.model_body, t2.model_body],
        ['Engine (cc)', t1.model_engine_cc, t2.model_engine_cc],
        ['Power (hp)', t1.model_engine_power_ps, t2.model_engine_power_ps],
        ['Torque (Nm)', t1.model_engine_torque_nm, t2.model_engine_torque_nm],
        ['Fuel', t1.model_engine_fuel, t2.model_engine_fuel],
        ['Transmission', t1.model_transmission_type, t2.model_transmission_type],
        ['Doors', t1.model_doors, t2.model_doors],
        ['Seats', t1.model_seats, t2.model_seats]
      ];

      let html = `<table class="compareTable"><thead><tr><th></th><th>${t1.make_display} ${t1.model_name}</th><th>${t2.make_display} ${t2.model_name}</th></tr></thead><tbody>`;
      fields.forEach(([label, v1, v2]) => {
        html += `<tr><th>${label}</th><td>${v1 || '—'}</td><td>${v2 || '—'}</td></tr>`;
      });
      html += '</tbody></table><div class="small" style="margin-top:8px">Data from CarQuery API.</div>';
      out.innerHTML = html;
    } catch (err) {
      console.error(err);
      out.innerHTML = '<span style="color:#b91c1c">Error fetching comparison. Try again later.</span>';
    }
  }

  function clearCompare() {
    ['cmp-make1', 'cmp-model1', 'cmp-make2', 'cmp-model2'].forEach(id => (document.getElementById(id).value = ''));
    const out = document.getElementById('compare-result');
    out.style.display = 'none';
    out.innerHTML = '';
  }

  // ========= Fuel Cost Calculator =========
  function calcFuel() {
    const d = parseFloat(document.getElementById('fc-distance').value);
    const eff = parseFloat(document.getElementById('fc-efficiency').value);
    const price = parseFloat(document.getElementById('fc-price').value);
    const mult = parseFloat(document.getElementById('fc-mult').value) || 1;
    const out = document.getElementById('fuel-result');
    out.style.display = 'block';

    if (!d || !eff || !price) {
      out.innerHTML = '<span style="color:#b91c1c">Fill all required fields.</span>';
      return;
    }

    const litres = d / eff;
    const cost = litres * price * mult;
    out.innerHTML = `<div><strong>Fuel needed:</strong> ${litres.toFixed(2)} L</div>
                     <div style="margin-top:6px"><strong>Total cost:</strong> ${cost.toFixed(2)}</div>
                     <div class="small" style="margin-top:6px">Approximation — actual may vary.</div>`;
  }

  function clearFuel() {
    ['fc-distance', 'fc-efficiency', 'fc-price'].forEach(id => (document.getElementById(id).value = ''));
    document.getElementById('fc-mult').value = '1';
    const out = document.getElementById('fuel-result');
    out.style.display = 'none';
    out.innerHTML = '';
  }
</script>
